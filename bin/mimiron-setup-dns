#!/bin/bash

# Configure DNS using systemd-resolved (works with NetworkManager)

if [[ -z $1 ]]; then
  if command -v gum &>/dev/null; then
    dns=$(gum choose --height 5 --header "Select DNS provider" Cloudflare DHCP Custom)
  else
    echo "Select DNS provider:"
    echo "1) Cloudflare"
    echo "2) DHCP (default)"
    echo "3) Custom"
    read -p "Choice [1-3]: " choice
    case $choice in
      1) dns="Cloudflare" ;;
      2) dns="DHCP" ;;
      3) dns="Custom" ;;
      *) echo "Invalid choice"; exit 1 ;;
    esac
  fi
else
  dns=$1
fi

case "$dns" in
Cloudflare)
  echo "Configuring Cloudflare DNS with DNS-over-TLS..."

  sudo tee /etc/systemd/resolved.conf >/dev/null <<'EOF'
[Resolve]
DNS=1.1.1.1#cloudflare-dns.com 1.0.0.1#cloudflare-dns.com
FallbackDNS=9.9.9.9 149.112.112.112
DNSOverTLS=opportunistic
EOF

  # Tell NetworkManager to use systemd-resolved
  sudo tee /etc/NetworkManager/conf.d/dns.conf >/dev/null <<'EOF'
[main]
dns=systemd-resolved
EOF

  # Symlink resolv.conf to systemd-resolved stub
  sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf

  # Restart services
  sudo systemctl enable systemd-resolved
  sudo systemctl restart systemd-resolved NetworkManager

  echo "✓ Cloudflare DNS configured with DNS-over-TLS"
  echo "  Testing DNS resolution..."
  sleep 2
  if resolvectl query cloudflare.com &>/dev/null; then
    echo "✓ DNS working correctly"
  else
    echo "⚠ DNS test failed - check 'resolvectl status'"
  fi
  ;;

DHCP)
  echo "Configuring DHCP DNS (default)..."

  sudo tee /etc/systemd/resolved.conf >/dev/null <<'EOF'
[Resolve]
DNSOverTLS=no
EOF

  # Tell NetworkManager to use systemd-resolved
  sudo tee /etc/NetworkManager/conf.d/dns.conf >/dev/null <<'EOF'
[main]
dns=systemd-resolved
EOF

  # Symlink resolv.conf to systemd-resolved stub
  sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf

  # Restart services
  sudo systemctl enable systemd-resolved
  sudo systemctl restart systemd-resolved NetworkManager

  echo "✓ DHCP DNS configured"
  ;;

Custom)
  echo "Enter your DNS servers (space-separated, e.g. '192.168.1.1 1.1.1.1'):"
  read -r dns_servers

  if [[ -z "$dns_servers" ]]; then
    echo "Error: No DNS servers provided."
    exit 1
  fi

  sudo tee /etc/systemd/resolved.conf >/dev/null <<EOF
[Resolve]
DNS=$dns_servers
FallbackDNS=9.9.9.9 149.112.112.112
EOF

  # Tell NetworkManager to use systemd-resolved
  sudo tee /etc/NetworkManager/conf.d/dns.conf >/dev/null <<'EOF'
[main]
dns=systemd-resolved
EOF

  # Symlink resolv.conf to systemd-resolved stub
  sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf

  # Restart services
  sudo systemctl enable systemd-resolved
  sudo systemctl restart systemd-resolved NetworkManager

  echo "✓ Custom DNS configured: $dns_servers"
  ;;
esac

echo ""
echo "Check DNS status with: resolvectl status"
