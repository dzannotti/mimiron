#!/bin/bash
# Mimiron GPG Setup Script
# Sets up GPG key for commit signing

set -euo pipefail

echo "==> Mimiron GPG Setup"
echo

# Check if GPG key already exists
if gpg --list-secret-keys --keyid-format=long | grep -q "dzannotti@me.com"; then
    echo "✓ GPG key already exists for dzannotti@me.com"
    KEY_ID=$(gpg --list-secret-keys --keyid-format=long dzannotti@me.com | grep sec | awk '{print $2}' | cut -d'/' -f2)
    echo "  Key ID: $KEY_ID"
else
    echo "Creating new GPG key for dzannotti@me.com..."

    # Create GPG key config
    cat > /tmp/gpg-batch.conf << 'EOF'
Key-Type: RSA
Key-Length: 4096
Subkey-Type: RSA
Subkey-Length: 4096
Name-Real: dzannotti
Name-Email: dzannotti@me.com
Expire-Date: 0
%no-protection
%commit
EOF

    # Generate key
    gpg --batch --gen-key /tmp/gpg-batch.conf
    rm /tmp/gpg-batch.conf

    # Get the key ID
    KEY_ID=$(gpg --list-secret-keys --keyid-format=long dzannotti@me.com | grep sec | awk '{print $2}' | cut -d'/' -f2)
    echo "✓ GPG key created successfully"
    echo "  Key ID: $KEY_ID"
fi

# Configure git
echo
echo "Configuring git to use GPG key..."
git config --global user.signingkey "$KEY_ID"
git config --global commit.gpgsign true
echo "✓ Git configured for GPG signing"

# Export public key
echo
echo "Exporting public key..."
gpg --armor --export "$KEY_ID" > ~/.local/share/mimiron/gpg-public-key.asc
echo "✓ Public key saved to ~/.local/share/mimiron/gpg-public-key.asc"

# Show instructions
echo
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Next steps:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo
echo "1. Add your GPG key to GitHub:"
echo "   https://github.com/settings/gpg/new"
echo
echo "2. Copy your public key:"
echo "   cat ~/.local/share/mimiron/gpg-public-key.asc | wl-copy"
echo
echo "   Or display it:"
echo "   cat ~/.local/share/mimiron/gpg-public-key.asc"
echo
echo "3. Your commits will now be signed automatically!"
echo
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
