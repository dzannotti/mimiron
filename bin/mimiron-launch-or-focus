#!/bin/bash

# Launch or focus an application window (GNOME Wayland compatible with Window Calls extension)
# Usage: mimiron-launch-or-focus [window-pattern] [launch-command]

if (($# == 0)); then
  echo "Usage: mimiron-launch-or-focus [window-pattern] [launch-command]"
  exit 1
fi

WINDOW_PATTERN="$1"
LAUNCH_COMMAND="${2:-"$WINDOW_PATTERN"}"

# Try wmctrl first (works for X11 apps like VSCode, Obsidian, Ferdium)
WINDOW_ID=$(wmctrl -lx | grep -i "$WINDOW_PATTERN" | head -n1 | awk '{print $1}')

if [[ -n $WINDOW_ID ]]; then
  # Window found via wmctrl, focus it
  wmctrl -ia "$WINDOW_ID"
  exit 0
fi

# Fallback: Try Window Calls extension for Wayland apps (Chrome, Ghostty)
# This requires the window-calls@domandoman.xyz extension to be installed
WINDOW_INFO=$(gdbus call --session \
  --dest org.gnome.Shell \
  --object-path /org/gnome/Shell/Extensions/Windows \
  --method org.gnome.Shell.Extensions.Windows.List 2>/dev/null | \
  sed "s/^('//; s/',)$//")

if [[ -n "$WINDOW_INFO" ]]; then
  # Extract window id matching the pattern (case-insensitive)
  WAYLAND_WINDOW_ID=$(echo "$WINDOW_INFO" | jq -r --arg pattern "$WINDOW_PATTERN" \
    '.[] | select((.wm_class | ascii_downcase | contains($pattern | ascii_downcase)) or (.wm_class_instance | ascii_downcase | contains($pattern | ascii_downcase))) | .id' \
    2>/dev/null | head -n1)

  if [[ -n "$WAYLAND_WINDOW_ID" ]]; then
    # Activate the window using Window Calls extension
    gdbus call --session \
      --dest org.gnome.Shell \
      --object-path /org/gnome/Shell/Extensions/Windows \
      --method org.gnome.Shell.Extensions.Windows.Activate \
      "$WAYLAND_WINDOW_ID" >/dev/null 2>&1
    exit 0
  fi
fi

# Window doesn't exist, launch the application
eval exec "$LAUNCH_COMMAND" &
