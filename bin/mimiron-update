#!/usr/bin/env zsh
# ============================================================================
# Mimiron System Update & Maintenance Script
# Combines system updates with spring-clean maintenance tasks
# ============================================================================

set -euo pipefail
trap 'echo "[!] Script aborted by user."; exit 1' INT TERM

# -------------------------------------
# Detect AUR helper (yay or paru)
# -------------------------------------

if command -v yay &>/dev/null; then
  AUR=yay
elif command -v paru &>/dev/null; then
  AUR=paru
else
  echo "Error: You need to install either 'yay' or 'paru' to use this script." >&2
  exit 1
fi

# -------------------------------------
# Set up logging and configuration
# -------------------------------------

LOG_DIR="$HOME/.local/var/log"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/mimiron-update-$(date +%F_%H-%M-%S).log"

PACCACHE_RETAIN=2     # Keep only the latest 2 versions of packages
CACHE_DAYS=30         # Delete ~/.cache files older than 30 days
JOURNAL_RETAIN="7d"   # Keep only 7 days of system logs

exec > >(tee -a "$LOG_FILE") 2>&1  # Everything goes to log file AND terminal

# -------------------------------------
# Helper functions
# -------------------------------------

confirm() {
  read -r -p "${1:-Are you sure? [y/N]} " ans
  [[ "$ans" =~ ^([yY][eE][sS]|[yY])$ ]]
}

announce() {
  printf "\n\e[1;32mðŸ”¹ %s\e[0m\n" "$1"
}

step() {
  printf "\n\e[1;34m==> %s\e[0m\n" "$1"
}

# -------------------------------------
# Parse options
# -------------------------------------

DO_CLEAN=false
while [[ $# -gt 0 ]]; do
  case $1 in
    -c|--clean) DO_CLEAN=true; shift ;;
    -h|--help)
      echo "Usage: $0 [--clean]"
      echo "       --clean     Also perform spring-clean maintenance tasks"
      exit 0 ;;
    *) echo "Unknown option: $1" ; exit 2 ;;
  esac
done

announce "Mimiron System Update Starting â€” Using AUR Helper: $AUR"
echo "Log file saved to: $LOG_FILE"

# -------------------------------------
# 1: Create Snapper Snapshot
# -------------------------------------

if command -v snapper &>/dev/null; then
  step "CREATING PRE-UPDATE SNAPSHOT"
  sudo snapper -c root create --description "Before system update ($(date +%F))"
  echo "âœ“ Snapshot created"
else
  echo "âš  Snapper not available, skipping snapshot"
fi

# -------------------------------------
# 2: Update Mimiron Configuration
# -------------------------------------

step "UPDATING MIMIRON CONFIGURATION"
cd ~/.local/share/mimiron
if git pull; then
  echo "âœ“ Mimiron config updated"
else
  echo "âš  Failed to update Mimiron config (continuing anyway)"
fi

# -------------------------------------
# 3: System Package Update
# -------------------------------------

step "UPGRADING SYSTEM PACKAGES"
echo "This will update all official and AUR packages."
$AUR -Syu
echo "âœ“ System packages updated"
echo "NOTE: After upgrade, run: sudo pacdiff â€” to handle .pacnew files."

# -------------------------------------
# Optional: Spring-Clean Maintenance
# -------------------------------------

if $DO_CLEAN; then
  announce "Running Spring-Clean Maintenance Tasks"

  # Clean Pacman Cache
  step "CLEANING PACKAGE CACHE"
  current_cache=$(du -sh /var/cache/pacman/pkg | cut -f1)
  echo "Current cache size: $current_cache"

  if confirm "Clean old package cache (keep last $PACCACHE_RETAIN)? [y/N]"; then
    sudo paccache -vrk $PACCACHE_RETAIN
    sudo paccache -ruk0
    new_cache=$(du -sh /var/cache/pacman/pkg | cut -f1)
    echo "New cache size: $new_cache"
  else
    echo "Skipped cache cleanup."
  fi

  # Remove Orphaned Packages
  step "REMOVING UNUSED (ORPHANED) PACKAGES"
  mapfile -t ORPHANS < <($AUR -Qtdq)
  if ((${#ORPHANS[@]})); then
    echo "Found ${#ORPHANS[@]} orphaned packages:"
    printf '%s\n' "${ORPHANS[@]}"
    if confirm "Remove these unneeded packages? [y/N]"; then
      sudo pacman -Rns "${ORPHANS[@]}"
    else
      echo "Skipped removing orphans."
    fi
  else
    echo "No orphaned packages found. All clean!"
  fi

  # Prune ~/.cache
  step "CLEANING ~/.cache DIRECTORY"
  before_cache=$(du -sh ~/.cache | cut -f1)
  echo "Cache size before cleanup: $before_cache"

  if confirm "Delete files older than $CACHE_DAYS days from ~/.cache? [y/N]"; then
    find ~/.cache -type f -mtime +$CACHE_DAYS -print -delete
    find ~/.cache -type d -empty -print -delete
    after_cache=$(du -sh ~/.cache | cut -f1)
    echo "Cache size after cleanup: $after_cache"
  else
    echo "Skipped cleaning ~/.cache."
  fi

  # Clean old system logs
  step "VACUUMING SYSTEM LOGS (journald)"
  before_logs=$(journalctl --disk-usage | awk '{print $NF}')
  echo "Current journal size: $before_logs"

  if confirm "Delete logs older than $JOURNAL_RETAIN? [y/N]"; then
    sudo journalctl --rotate
    sudo journalctl --vacuum-time=$JOURNAL_RETAIN
    after_logs=$(journalctl --disk-usage | awk '{print $NF}')
    echo "Journal size after vacuum: $after_logs"
  else
    echo "Skipped journald cleanup."
  fi

  # Check for Failed Services
  step "CHECKING FOR FAILED SYSTEMD SERVICES"
  if systemctl --failed --quiet; then
    echo "âœ… No failed services found."
  else
    echo "âš ï¸ Some services have failed:"
    systemctl --failed --no-pager --plain
  fi
fi

# -------------------------------------
# 4: Check if Restart is Needed
# -------------------------------------

step "CHECKING IF REBOOT IS REQUIRED"

# Check if running kernel version matches installed kernel
if [ "$(uname -r | sed 's/-arch/\.arch/')" != "$(pacman -Q linux | awk '{print $2}')" ]; then
  echo "âš ï¸ Linux kernel has been updated. Reboot required."
  if command -v gum &>/dev/null; then
    gum confirm "Reboot now?" && sudo reboot now
  else
    confirm "Reboot now? [y/N]" && sudo reboot now
  fi
else
  echo "âœ… No reboot required"
fi

# -------------------------------------
# Finished
# -------------------------------------

announce "âœ… Mimiron Update Completed in ${SECONDS}s"
echo "Full log saved to: $LOG_FILE"
